![Python](https://img.shields.io/badge/Python-3.11-blue)
![FastAPI](https://img.shields.io/badge/FastAPI-0.111.0+-green)
![SQLAlchemy](https://img.shields.io/badge/SQLAlchemy-v2.0+-green)

<br/>
<h1 align="center">
FastAPIåç«¯é¡¹ç›®æ¡†æ¶
</h1>
<h4 align="center">ä¸“æ³¨äºä½ çš„ä¸šåŠ¡é€»è¾‘.</h4>
<br/>

# ğŸ’¡ åŠŸèƒ½ç‰¹ç‚¹

- å®¹å™¨åŒ–ï¼šæä¾›DockeråŠdocker-composeæ–‡ä»¶ï¼ŒæŒ‰éœ€ä¿®æ”¹å…¶ä¸­çš„å‚æ•°å³å¯ä½¿ç”¨ï¼ˆä¸æ”¹ä¹Ÿèƒ½ç”¨ï¼‰
- è½»é‡åŒ–ï¼šä¾èµ–çš„åº“å°½å¯èƒ½çš„å°‘
- åˆ†å±‚å½’ç±»ï¼šå®ä½“ã€æšä¸¾ã€ä¸šåŠ¡é€»è¾‘æ¡ç†æ¸…æ™°
- å°è£…ï¼šæ¥å£çš„è¯·æ±‚å“åº”ç­‰å¸¸è§„å†…å®¹å‡è¿›è¡Œäº†ç»Ÿä¸€çš„å°è£…ï¼Œä¸“æ³¨äºå®ç°ä¸šåŠ¡é€»è¾‘æœ¬èº«å°±å¥½

# âš¡ å¿«é€Ÿå¼€å§‹

## æœ¬åœ°å¼€å‘

1. `pip install -r requirements.txt` å®‰è£…ä¾èµ–
2. å®‰è£…pre-commitï¼Œ`pip install pre-commit`
3. è¿è¡Œ`pre-commit install`å®‰è£…pre-commité’©å­
4. è¿è¡Œ`pre-commit run -a`åˆå§‹åŒ–repos
5. è¿è¡Œmain.pyæ–‡ä»¶å¯åŠ¨APIæœåŠ¡

## æ„å»ºé•œåƒ

```
docker build -t {image-name}:latest .
```

## æ•°æ®è¿ç§»

[versions](migrations%2Fversions)ç›®å½•ä¸‹å­˜æ”¾ç€å½“å‰ç‰ˆæœ¬çš„æ•°æ®åº“è¿ç§»è„šæœ¬ï¼Œæ‰§è¡Œ`alembic upgrade head`å‘½ä»¤è¿›è¡Œæ•°æ®åº“è¿ç§»ã€‚

ä»£ç ä¸­è°ƒæ•´äº†modelçš„å®šä¹‰åä½¿ç”¨`alembic revision --autogenerate`é‡æ–°ç”Ÿæˆè¿ç§»è„šæœ¬ã€‚
**autogenerateåªèƒ½æŒ‰ç…§[script.py.mako](migrations%2Fscript.py.mako)æ¨¡æ¿ç”Ÿæˆè¿ç§»è„šæœ¬ï¼Œå…·ä½“çš„{version}_upgrade.sql/{version}_downgrade.sqléœ€è¦æ ¹æ®å˜æ›´æä¾›**


### ç‰ˆæœ¬å·ç®¡ç†:

*å»ºè®®æ¯ä¸ªç‰ˆæœ¬ä»…ä¿ç•™ä¸€ä¸ªç‰ˆæœ¬å¯¹åº”çš„è¿ç§»è„šæœ¬ï¼Œå¤šæ¬¡bugfixçš„æƒ…å†µä¸‹åœ¨æœ€ç»ˆç¡®å®šç‰ˆæœ¬æ—¶ç”Ÿæˆä¸€ä¸ªå½“å‰ç‰ˆæœ¬æœ€ç»ˆçš„è¿ç§»è„šæœ¬ã€‚*
å…·ä½“ç‰ˆæœ¬å·å‘½åè§„åˆ™æŒ‰éœ€è°ƒæ•´ï¼Œä»¥ä¸‹ä»…ä¸ºç¤ºä¾‹ï¼šå…¶ä¸­v1.0ä¸ºå‰ä¸€æ¬¡çš„å‘å¸ƒç‰ˆæœ¬ï¼Œv1.1ä¸ºå½“å‰ç‰ˆæœ¬ã€‚è¿‡ç¨‹ä¸­çš„~~v1.0.1~~ -> ~~v1.0.2~~ -> ~~v1.0.3~~åœ¨æœ€ç»ˆå‘å¸ƒv1.1è¿›è¡Œæ•´åˆå¹¶åˆ é™¤ã€‚
v1.0 -> ~~v1.0.1~~ -> ~~v1.0.2~~ -> ~~v1.0.3~~ -> v1.1 = v1.0 -> v1.1

# ğŸ“„ ç»“æ„ä»‹ç»

## æ¶æ„è®¾è®¡

<table>
  <tr>
    <th>åŸºç¡€ç»„ä»¶</th>
    <th>ä¸šåŠ¡é€»è¾‘</th>
    <th>å¯¹å¤–æ¥å£</th>
    <th>ç¨‹åºå…¥å£</th>
  </tr>
    <tr>
    <td>common</td>
    <td rowspan="3">modules</td>
    <td rowspan="3">api</td>
    <td>main.py</td>
  </tr>
  <tr>
    <td>components</td>
    <td>command.py</td>
  </tr>
  <tr>
    <td>config</td>
  </tr>
</table>

*ç³»ç»Ÿä¸»è¦ç”±ä¸Šè¿°äº”ä¸ªéƒ¨åˆ†+ä¸¤ä¸ªå…¥å£ç‚¹ç»„æˆï¼Œè¡¨æ ¼è¶Šå¾€å³å±‚çº§è¶Šé«˜*

### è°ƒç”¨åŸåˆ™
â€» **å…è®¸åŒå±‚è°ƒç”¨ï¼Œå…è®¸åŒå±‚è°ƒç”¨ä»»æ„æ›´ä½å±‚çº§çš„ä»£ç ï¼Œä¸¥ç¦è°ƒç”¨æ›´é«˜å±‚çº§çš„ä»£ç **

### ç»„ä»¶è¯´æ˜
PS: *æœ¬éƒ¨åˆ†æŒ‰ç…§ä½¿ç”¨çš„å…ˆåé¡ºåºè¿›è¡Œæ’åºï¼Œä¸æŒ‰ç…§å­—æ¯é¡ºåºè¿›è¡Œæ’åº*
- [config](config): ä»£ç ä¸­åº”è¯¥ä¸¥æ ¼æœç»ç¡¬ç¼–ç çš„è¡Œä¸ºï¼Œå› æ­¤æŠŠå‚æ•°éƒ½å®šä¹‰åœ¨configä¸­ã€‚configçš„å¯¼å‡ºé™åˆ¶ä¸­é™å®šäº†ä»…å¯¼å‡ºCONFIGå’ŒCONSTANTSä¸¤ä¸ªå®ä¾‹
  - CONFIGï¼šåŒ…å«å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡åœ¨å¯åŠ¨ç¨‹åºæ—¶ä¿®æ”¹çš„å‚æ•°ï¼Œå› ä¸ºåœ¨ç±»ä¸­æ˜¾è‘—çš„æ ‡æ˜å±æ€§å’Œç±»å‹ï¼Œå› æ­¤ä¸è¦å†ä½†æ˜¯å‚æ•°å¤šäº†çš„æ—¶å€™ä¸çŸ¥é“éƒ½æœ‰å“ªäº›å‚æ•°çš„é—®é¢˜ã€‚
  - CONSTANTSï¼šåŒ…å«ä¸€äº›ä¸šåŠ¡æ— å…³çš„å¸¸é‡å€¼ï¼Œæ¯”å¦‚è¯´æ—¶é—´ç±»å‹åºåˆ—åŒ–æ—¶çš„æ ¼å¼ç­‰ã€‚
- [components](components): componentsæ˜¯å¯¹ä¸šåŠ¡æ— å…³çš„ä¸€äº›å¤„ç†é€»è¾‘çš„å°è£…ï¼Œå¦‚æœæ˜¯é«˜åº¦èšåˆçš„æ“ä½œå°±å°è£…æˆManagerç±»ï¼Œæ¯”å¦‚å¯¹kafkaçš„æ“ä½œå°±å°è£…åˆ°KafkaManagerç±»ä¸­ï¼Œå¦‚æœæ˜¯å•ç‹¬çš„å‡½æ•°é€»è¾‘å°±å¯ä»¥éƒ½æ”¾åˆ°functionsä¸­ã€‚å¦å¤–componentsçš„__init__ä¸­å¯¹åˆ†æ•£åœ¨å„ä¸ªæ–‡ä»¶ä¸­çš„å°è£…ç»„ä»¶è¿›è¡Œäº†æ±‡æ€»åŒæ—¶é™åˆ¶äº†å¯¼å‡ºçš„å†…å®¹ï¼Œè¿™æ ·ä½¿ç”¨çš„æ—¶å€™åªéœ€è¦ä»componentså¯¼å…¥*æˆ–è€…ç‰¹å®šå†…å®¹å³å¯è€Œæ— éœ€çŸ¥é“æ˜¯åœ¨componentsçš„functionsä¸­è¿˜æ˜¯redisä¸­ã€‚
- [common](common): commonä¹Ÿæ˜¯å¯¹ä¸šåŠ¡æ— å…³çš„å°è£…ï¼Œä½†æ˜¯å’Œcomponentsä¸åŒï¼Œcommonä¸­ä¸»è¦å°è£…çš„æ˜¯å„ç§â€œå®šä¹‰â€æˆ–è€…è¯´åŸºç±»ï¼ŒåŒæ—¶å› ä¸ºcommonä¸­çš„æ–‡ä»¶æ˜¯æŒ‰ç…§åº”ç”¨åœºæ™¯çš„ç±»å‹åˆ’åˆ†çš„ï¼Œå› æ­¤ä¹Ÿå°±æ²¡æœ‰åœ¨__init__ä¸­å¯¹åˆ†æ•£åœ¨å„ä¸ªæ–‡ä»¶ä¸­çš„å®šä¹‰è¿›è¡Œæ±‡æ€»ã€‚
- [modules](modules): ä¸Šé¢çš„æ‰€æœ‰å°è£…éƒ½å¼ºè°ƒäº†ä¸€ç‚¹å°±æ˜¯â€œä¸šåŠ¡æ— å…³â€æ€§ï¼Œå› æ­¤ä»–ä»¬æ˜¯åŸºç¡€ç»„ä»¶ã€‚äºæ­¤ç›¸å¯¹çš„ï¼Œç³»ç»Ÿä¸­åŒ…å«ä¼—å¤šä¸šåŠ¡é€»è¾‘ï¼Œè¿™äº›ä¸šåŠ¡é€»è¾‘ä¹Ÿéƒ½å¯ä»¥æŒ‰ç…§åŠŸèƒ½æ¨¡å‹è¿›è¡Œæ‹†åˆ†ï¼Œå› æ­¤modulesä¸­å­˜æ”¾çš„å°±æ˜¯ä¸šåŠ¡é€»è¾‘æ¨¡å—ã€‚modulesä¸‹åº”è¯¥åŒ…å«çš„æ˜¯å„ä¸ªä¸šåŠ¡æ¨¡å—ï¼Œå› æ­¤å…·ä½“å«ä»€ä¹ˆå°±å› ä¸šåŠ¡é€»è¾‘è€Œå®šï¼Œä½†æ˜¯æ¯ä¸ªä¸šåŠ¡é€»è¾‘æ¨¡å—ä¸­åŒ…å«çš„æ–‡ä»¶å®šä¹‰åº”è¯¥æœ‰ä¸€å®šçš„æ ‡å‡†ï¼Œä¸‹é¢è¿˜æ˜¯æŒ‰ç…§åº”ç”¨çš„å…ˆåé¡ºåºè¿›è¡Œè¯´æ˜ï¼š
  - [å¯é€‰]constants.py: ä¸Šé¢æåˆ°äº†CONSTANTSä¸­éƒ½æ˜¯ä¸šåŠ¡é€»è¾‘æ— å…³çš„å¸¸é‡ï¼Œé‚£å¦‚æœæˆ‘éœ€è¦å®šä¹‰ä¸€äº›è·Ÿä¸šåŠ¡é€»è¾‘ç›¸å…³çš„å‘¢ï¼Ÿå°±æ¯”å¦‚æˆ‘æœ‰ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„åç§°ï¼Œä»£ç ä¸­ä¸¥ç¦ç¡¬ç¼–ç çš„è¯å†™åˆ°å“ªå‘¢ï¼Œå½“ç„¶å°±æ˜¯å†™åˆ°è‡ªå·±æ¨¡å—çš„constantsæ–‡ä»¶ä¸­ã€‚
  - [å¯é€‰]enums.py: åœ¨è¿›è¡Œæ•°æ®ç»“æ„è®¾è®¡çš„æ—¶å€™å¯èƒ½ä¼šå­˜åœ¨ä¸€ä¸‹æšä¸¾ç±»å‹ï¼Œè¿™äº›æšä¸¾ç±»å‹æ˜¯è·Ÿä¸šåŠ¡ç›¸å…³çš„ï¼Œå°±æ¯”å¦‚è¯´ç”¨æˆ·ç±»å‹æšä¸¾å°±åº”è¯¥æ”¾åˆ°ç”¨æˆ·æ¨¡å—ä¸­è¿›è¡Œå®šä¹‰ã€‚
  - [å¯é€‰]models.py: æ•°æ®åº“æ¨¡å‹å®šä¹‰ï¼Œå¦‚æœå½“å‰ä¸šåŠ¡é€»è¾‘æ¶‰åŠåˆ°è·Ÿæ•°æ®åº“äº¤äº’çš„è¯ï¼Œä¸šåŠ¡æ‰€å±çš„modelåº”è¯¥å®šä¹‰åœ¨è¿™é‡Œã€‚
  - [å¯é€‰]schemas.py: è¯´å¯é€‰ä¹Ÿä¸ç®—æ˜¯ï¼Œé™¤éå½“å‰ä¸šåŠ¡æ¨¡å—ä¸å¯¹å¤–æä¾›APIæ¥å£æˆ–è€…è™½ç„¶æä¾›æ¥å£ä½†æ˜¯éƒ½æ˜¯ç®€å•çš„æ•°æ®ç»“æ„ï¼Œä¸ç„¶è·ŸAPIç›¸å…³çš„æ•°æ®ç»“æ„å®šä¹‰éƒ½åœ¨è¿™é‡Œã€‚å¦‚æœè·Ÿæ¥å£å¼ºç›¸å…³çš„å»ºè®®å°±æ˜¯xxxRequest\xxxResponseè¿™æ ·æ˜ç¡®è¡¨ç¤ºç”¨äºå“ªä¸ªæ¥å£ï¼Œå¦‚æœè·Ÿæ¥å£ä¸å¼ºç›¸å…³åˆ™åº”è¯¥æ˜¯xxxSchemaè¡¨æ˜è¿™æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„çš„å®šä¹‰ä»¥å…è·Ÿmodelä¸­çš„modelå®šä¹‰æ··æ·†ã€‚
  - [å¯é€‰]controller.py: ä¸šåŠ¡é€»è¾‘çš„å°è£…ï¼Œå»ºè®®å°±å«åšxxxControlleræŠŠç›¸å…³é€»è¾‘éƒ½å°è£…åˆ°ä¸€ä¸ªç±»ä¸­ï¼Œå¯¼å‡ºä½¿ç”¨ä¹Ÿæ–¹ä¾¿ã€‚ï¼ˆPSï¼šä¹‹æ‰€ä»¥å¯é€‰æ˜¯å› ä¸ºå»ºè®®å°è£…çš„æ˜¯è¾ƒä¸ºç¹çæˆ–è€…è¯´å¯èƒ½è¢«å¤šä¸ªæ¥å£å…±ç”¨åˆ°çš„é€»è¾‘ï¼Œå¦‚æœæ˜¯è·Ÿç‰¹å®šæ¥å£å¼ºç›¸å…³çš„æŸ¥è¯¢ä¹‹ç±»çš„é€»è¾‘è¿˜æ˜¯ç›´æ¥å†™åœ¨ç‰¹å®šçš„APIä¸­æ¯”è¾ƒå¥½ï¼‰ã€‚
  - [å¯é€‰]command.py: å¦‚æœå½“å‰ä¸šåŠ¡æ¨¡å—éœ€è¦æœ‰ä¸€äº›è·ŸAPIæœåŠ¡å¹¶è¡Œçš„åå°æœåŠ¡åˆ™éœ€è¦å®šä¹‰è¯¥æ–‡ä»¶ï¼Œå…¶ä¸­éœ€è¦å®ç°ä¸€ä¸ªä½¿ç”¨CommandBaseå…ƒç±»çš„å­ç±»ï¼ˆä½¿ç”¨å…ƒç±»åè¿›è¡Œè‡ªåŠ¨æ³¨å†Œï¼‰ã€‚
  - [å¯é€‰]å…¶ä»–æŒ‰éœ€å®šä¹‰çš„æ¨¡å—æ–‡ä»¶

## å…¥å£ç‚¹

é¡¹ç›®ä¸€å…±æä¾›ä¸¤ç§å…¥å£ç‚¹ï¼Œåˆ†åˆ«æ˜¯ï¼š

- [main.py](main.py): å¯åŠ¨APIæœåŠ¡ï¼ŒåŒæ—¶å¯¹APIæ¥å£çš„é”™è¯¯å“åº”è¿›è¡ŒæŒ‡å®šæ ¼å¼çš„è½¬åŒ–å¤„ç†ã€‚
- [command.py](command.py): é€šè¿‡ç»ˆç«¯æ‰§è¡Œçš„å…¶ä»–åå°ä»»åŠ¡ã€‚PS:commandæ–‡ä»¶ä¸éœ€è¦å†è¿›è¡Œä¿®æ”¹ï¼Œä¸šåŠ¡æ¨¡å—è‡ªå·±çš„å‘½ä»¤åªéœ€è¦æŒ‰ç…§ä¸Šé¢çš„è¦æ±‚è¿›è¡Œå®ç°commandåœ¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šè‡ªåŠ¨æ³¨å†Œå¹¶å‘ç°ã€‚

ä¹‹æ‰€ä»¥è¿™æ ·è®¾è®¡æ˜¯è€ƒè™‘åˆ°é™¤äº†æä¾›APIæœåŠ¡å¤–è¿˜å¯èƒ½å­˜åœ¨ä¸€äº›åå°ä»»åŠ¡ï¼Œæ¯”å¦‚æŒç»­å¤„ç†æ•°æ®ä¹‹ç±»çš„ã€‚

### Q & A
Q: ä¸ºä»€ä¹ˆä¸æŠŠmain.pyå’Œcommand.pyåˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ï¼Ÿ
A: ä¸»è¦æ˜¯è€ƒè™‘åˆ°äºŒè€…çš„æ ¹æœ¬ç»“æ„å’Œç›®çš„éƒ½ä¸ä¸€æ ·ï¼Œå•ç‹¬æ‹†åˆ†å¼€ä¹Ÿèƒ½æ›´å¥½çš„è§£è€¦åˆã€‚debugçš„æ—¶å€™å¯åŠ¨mainä¹Ÿä¸éœ€è¦æä¾›ä»€ä¹ˆè€Œå¤–çš„å‚æ•°ã€‚

## APIæ¥å£

APIæ¥å£çš„è®¾è®¡ä¸»è¦éµå¾ªRESTful APIè®¾è®¡è§„èŒƒï¼ŒåŒæ—¶å¯¹ä¸€äº›é«˜åº¦åŒè´¨åŒ–çš„å†…å®¹è¿›è¡Œäº†å°è£…å¤„ç†ã€‚
ä¸‹é¢å¯¹APIæ¨¡å—çš„ç‰¹å®šã€å®ç°çš„å°è£…ç­‰è¿›è¡Œè¯´æ˜ï¼š
- è‡ªåŠ¨æ³¨å†Œï¼šapiç›®å½•ä¸‹å·²ç»é¢„å…ˆæ”¾ç½®äº†[v1](api%2Fv1)ç›®å½•,ç¼–å†™æ¥å£æ—¶åªéœ€è¦åœ¨ç›®æ ‡æ–‡ä»¶å¤¹ä¸­æ–°å¢pythonæ–‡ä»¶å³å¯åœ¨å¯åŠ¨APIæœåŠ¡æ—¶è‡ªåŠ¨å®Œæˆæ¥å£è·¯å¾„çš„è¡¥å…¨ï¼šæ¥å£è·¯å¾„è§„åˆ™:
  /api/{v1}/{ä¸šåŠ¡æ¨¡å—}/{æ¥å£å®šä¹‰çš„å­path}ã€‚
- ç»Ÿä¸€åˆ†é¡µï¼šåˆ†é¡µç±»çš„æ¥å£å…¥å‚å’Œå‡ºå‚å®šä¹‰åº”è¯¥åˆ†åˆ«ç»§æ‰¿è‡ª`PaginateRequest`å’Œ`PaginateResponse`,ç„¶åæŸ¥è¯¢çš„æ—¶å€™åªéœ€è¦æ„å»ºå¥½æŸ¥è¯¢æ•°æ®çš„SQLè¯­å¥æŒ‰ç…§å‚æ•°è¦æ±‚è°ƒç”¨`paginate_query`æ–¹æ³•å³å¯ï¼ˆpaginate_queryå¯¹æ•°æ®çš„åˆ†é¡µã€å¯¼å‡ºæ–‡ä»¶ï¼Œæ€»æ•°æŸ¥è¯¢ç­‰é«˜åº¦åŒè´¨åŒ–çš„å†…å®¹éƒ½åšäº†å°è£…ï¼‰ã€‚
- é”™è¯¯å¤„ç†ï¼šå› ä¸ºéœ€è¦å¯¹é”™è¯¯å“åº”è¿›è¡Œç»Ÿä¸€çš„æ ¼å¼åŒ–ï¼Œå› æ­¤ä½¿ç”¨äº†`APIException`æ¥è¿›è¡Œé”™è¯¯æŠ›å‡ºï¼ŒåŒæ—¶ä¸ºäº†é¿å…ç¡¬ç¼–ç çš„å‡ºç°å¼•å…¥äº†`APICode`ç±»æ¥å®šä¹‰é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯ã€‚
- çŠ¶æ€ç ï¼šç›®å‰ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§çŠ¶æ€ç ï¼Œåˆ†åˆ«å¯¹åº”ä¸åŒçš„åœºæ™¯ï¼š
  - 200ï¼šæ•°æ®æŸ¥è¯¢æˆåŠŸæ—¶ï¼ˆä¾‹å¦‚ï¼šåˆ†é¡µã€è¯¦æƒ…ã€å›¾æ ‡ç­‰ï¼‰
  - 201ï¼šåˆ›å»ºæ•°æ®ç±»æ¥å£æˆåŠŸæ—¶ï¼ˆä¾‹å¦‚ï¼šæ–°å»ºæ•°æ®ã€åˆ›é€ ä»»åŠ¡ç­‰ï¼‰
  - 204ï¼šæ“ä½œç±»æ¥å£æ— éœ€è¿”å›æ•°æ®æ—¶ï¼ˆä¾‹å¦‚ï¼šåˆ é™¤ã€ç¼–è¾‘ï¼‰
  - 400ï¼šæ˜æ˜¾çš„å®¢æˆ·ç«¯é”™è¯¯ï¼ˆä¾‹å¦‚ï¼šæ ¼å¼é”™è¯¯çš„è¯·æ±‚è¯­æ³•ï¼Œå¤ªå¤§çš„å¤§å°ï¼Œæ— æ•ˆçš„è¯·æ±‚æ¶ˆæ¯æˆ–æ¬ºéª—æ€§è·¯ç”±è¯·æ±‚ï¼‰
  - 404ï¼šæ•°æ®ä¸å­˜åœ¨
  - 403ï¼šç¦æ­¢æ“ä½œ
  - 422ï¼šå…¥å‚ä¸æ­£ç¡®
  - 500ï¼šå¼‚åŒå¼‚å¸¸

# ğŸ“š ä½¿ç”¨å¸®åŠ©

æœ¬èŠ‚ä¸»è¦é’ˆå¯¹åŸºç¡€åŠŸèƒ½ä»£ç çš„ä½¿ç”¨è¿›è¡Œç¤ºä¾‹å±•ç¤º

- [common](common)ï¼š
  - [api.py](common%2Fapi.py)ï¼šç”¨äºAPIæ¥å£ï¼Œä¸»è¦ä½¿ç”¨åœºæ™¯æ˜¯æ·»åŠ æ¥å£è·¯ç”±ï¼š
    ```
    from common.api import *  # apiä¸­å‡ ä¹éƒ½æ˜¯éœ€è¦çš„ä¸œè¥¿ï¼ˆä¸éœ€è¦çš„å¯¼å…¥äº†ä¹Ÿä¸ä¼šäº§ç”Ÿå½±å“ï¼Œå› æ­¤å»ºè®®ç›´æ¥*å¯¼å…¥å…¨éƒ¨ï¼‰
    from modules.{ä¸šåŠ¡æ¨¡å—}.models import *
    from modules.{ä¸šåŠ¡æ¨¡å—}.schemas import *
    
    router = get_router()  # routerè¿™ä¸ªåå­—ä¸èƒ½å˜ï¼Œå› ä¸ºè‡ªåŠ¨æ³¨å†Œæ¥å£å°±æ˜¯æŒ‰ç…§è¿™ä¸ªåå­—æ¥å¤„ç†çš„
    
    # æ³¨å†Œç±»æ¥å£
    @router.post("", status_code=201)
    async def create_demo(request: DemoSchema):
        """
        ç¤ºä¾‹ï¼šæ–°å¢æ•°æ®
        """
        ...
    
    
    # åˆ é™¤æ•°æ®
    @router.delete("", status_code=204)
    async def delete_demo(request: list[str]):
        """
        ç¤ºä¾‹ï¼šåˆ é™¤æ•°æ®
        """
        ...
    
    
    
    # ç¼–è¾‘æ•°æ®
    @router.put("", status_code=204)
    async def edit_demo(request: DemoSchema):
        """
        ç¤ºä¾‹ï¼šä¿®æ”¹æ•°æ®
        """
        ...
    
    
    # åˆ†é¡µæŸ¥è¯¢
    @router.post("/demos")
    async def get_demo_list(request: DemosRequest) -> DemosResponse:
        """
        ç¤ºä¾‹ï¼šæŸ¥è¯¢åˆ—è¡¨
        """
        # ç”ŸæˆæŸ¥è¯¢è¯­å¥
        stmt = select(Demo.id, Demo.created_at)
        # æ·»åŠ è¿‡æ»¤æ¡ä»¶
        if query := request.query:
            # ä»¥ä¸‹ä¸‰ç§æ–¹å¼ç­‰ä»·
            # 1. ä½¿ç”¨é›†æˆçš„add_filtersï¼Œå¥½å¤„æ˜¯å¯ä»¥ä¸€æ¬¡æ€§æ·»åŠ ä¸Šæ‰€æœ‰çš„è¿‡æ»¤æ¡ä»¶
            stmt = add_filters(stmt, query, {Demo.created_at: FilterTypeEnum.Datetime})
            # 2. ä½¿ç”¨get_condition, å¥½å¤„åŒç±»å‹çš„å‚æ•°å¤„ç†è¿›è¡Œäº†å°è£…ï¼Œä¸”æ¯”add_filtersæ›´çµæ´»å¯ä»¥æŒ‡å®šå‚æ•°åº”ç”¨çš„ä½ç½®ï¼ˆwhereã€havingï¼‰
            if condition := get_condition(Demo.created_at, query.created_at, FilterTypeEnum.Datetime):
                stmt = stmt.where(condition)
            # 3. ç›´æ¥ä½¿ç”¨SQLAlchemyçš„SQLè¯­æ³•è¿›è¡Œæ“ä½œï¼Œæ“ä½œæœ€çµæ´»ï¼Œä½†ä¸æ˜“ç»Ÿä¸€ç»´æŠ¤
            if query.created_at:
                stmt = stmt.where(Demo.created_at.between(query.created_at.start, query.created_at.end))
        # ç»Ÿä¸€æ‰§è¡ŒæŸ¥è¯¢
        return paginate_query(stmt, request, DemosResponse)
    
    
    # æŸ¥è¯¢è¯¦æƒ…
    @router.get("/{id}")
    async def get_demo_detail(id: str) -> DemoSchema:
        """
        ç¤ºä¾‹ï¼šæŸ¥è¯¢è¯¦æƒ…
        """
        ...
    ```
  - [command.py](common%2Fcommand.py)ï¼šå¦‚æœéœ€è¦å®ç°åå°ä»»åŠ¡ï¼ˆä¸APIæœåŠ¡å¹¶è¡Œï¼‰ï¼Œåˆ™éœ€è¦åœ¨ä¸šåŠ¡æ¨¡å—çš„command.pyä¸­æŒ‰ç…§ä¸‹é¢çš„æ–¹å¼å®ç°è‡ªå®šä¹‰çš„Commandç±»ï¼š
    ```
    from common.command import CommandBase
    
    class DemoCommand(metaclass=CommandBase):
        name = "demo"  # å‘½ä»¤åç§°ï¼Œå¿…é¡»å”¯ä¸€ï¼Œè‡ªåŠ¨æ³¨å†Œå‘½ä»¤æ—¶ä¼šä½¿ç”¨è¿™ä¸ªåå­—ï¼ŒåŒæ—¶è¿™ä¸ªä¹Ÿæ˜¯python command.py {module} xxx ä¸­çš„moduleçš„å‚æ•°å€¼
      
        @staticmethod
        def add_parser(parser):
            parser.add_argument(
                "--username",
                default="admin",
                help="å‚æ•°è¯´æ˜",
            )
      
        @staticmethod
        def run(params):
            assert "username" in params
    ```
  - [model.py](common%2Fmodel.py)ï¼šå¦‚æœéœ€è¦å®šäºæ•°æ®åº“çš„ORMæ¨¡å‹ï¼Œåˆ™éœ€è¦åœ¨ä¸šåŠ¡æ¨¡å—çš„models.pyä¸­æŒ‰ç…§ä¸‹é¢çš„æ–¹å¼å®šä¹‰ï¼š
    ```
    from .enums import *
    from common.model import *


    class Demo(ModelBase, ModelTimeColumns):
        __tablename__ = "demo"

        type: Mapped[DemoTypeEnum]
        ...

    ```
  - [schema.py](common%2Fschema.py)ï¼šä¸šåŠ¡æ¨¡å—çš„schema.pyä¸­æŒ‰ç…§ä¸‹é¢çš„æ–¹å¼å®šä¹‰ï¼š
    ```
    from .enums import *
    from common.schema import *


    class DemoSchema(SchemaBase):
        id: str
        created_at: datetime
        updated_at: datetime
        type: DemoTypeEnum
    ```

- [components](components)ï¼šcomponentså’Œcommonä¸åŒï¼Œå°†å­å†…å®¹ç»Ÿä¸€è¿›è¡Œäº†æ±‡æ€»ï¼Œå› æ­¤å„ä¸ªä½¿ç”¨çš„åœ°æ–¹ç›´æ¥`from components import *`å³å¯ã€‚ä¸‹é¢å¯¹componentsæä¾›çš„ä¸»è¦åŠŸèƒ½è¿›è¡Œä»‹ç»ï¼š
  - `logger`ï¼šæœ¬è´¨å°±æ˜¯loguruçš„loggerï¼Œä½†æ˜¯å¦‚æœæ”¹ç”¨å…¶ä»–çš„æ—¥å¿—è®°å½•åº“å‘¢ï¼Œè°ƒç”¨ç«¯å¯ä»¥æ— æ„Ÿåˆ‡æ¢åªæ”¹è¿™é‡Œä¸€ä¸ªåœ°æ–¹å³å¯ï¼Œå› æ­¤ä»componentsä¸­ç›´æ¥å¯¼å…¥loggerã€‚åŒæ—¶ä¹Ÿå¯¹æ ¼å¼å’Œä½ç½®ç­‰è¿›è¡Œäº†ç»Ÿä¸€çš„é…ç½®ã€‚
    ```
    from components import *

    logger.info("hello world")
    ```
  - `DatabaseManager`ï¼š ç»Ÿä¸€å®ç°æ•°æ®åº“çš„è¿æ¥åˆ›å»ºã€å…³é—­ã€æäº¤å›æ»šç­‰é€»è¾‘
    ```
    from components import *
  
    with DatabaseManager() as db:
        # æŸ¥è¯¢
        result = db.scalar(select(Demo).where(Demo.id == xxx))
        # æ–°å¢
        demo = Demo(type=DemoTypeEnum.A)
        db.add(demo)
        # æ›´æ–°
        demo.type = DemoTypeEnum.B
        db.commit()
        # åˆ é™¤
        db.delete(demo)
        # db.commit() é»˜è®¤åœ¨é€€å‡ºä¸Šä¸‹æ–‡çš„æ—¶å€™è‡ªåŠ¨è¿›è¡Œæäº¤ï¼Œå› æ­¤ä¸éœ€è¦æ‰‹åŠ¨commitï¼Œå¦‚æœåœ¨è¿‡ç¨‹ä¸­éœ€è¦æäº¤æ•°æ®ä¹Ÿæ˜¯å¯ä»¥éšæ—¶æäº¤çš„
    ```
  - `generate_key`: IDç”Ÿæˆï¼Œé™¤äº†éšæœºidä¹Ÿå¯ä»¥æ ¹æ®è¾“å…¥çš„å†…å®¹æ¯æ¬¡éƒ½ç”Ÿæˆç›¸åŒçš„id
    ```
    from components import *
    
    generate_key()  # '5c874da8b177b613fa872e9c'
    generate_key()  # 'a3454ad598b4c53393614c02'
    generate_key('abc')  # '0fc55f5588d4d4fed43e64a8'
    assert generate_key('abc', 123) == '39fb5e13879b5430df95d870'
    generate_key(key_len=12)  # 'ef0685eadd03'
    generate_key(key_len=36)  # '3d4accaa58a84c25a0c2d599c83c3dee'
    generate_key(need_uuid=True)  # UUID('d855df18-e925-4aa6-8941-49ce2eb7b9dc')
    ```
  - `KafkaManager`ï¼šç»Ÿä¸€å®ç°kafkaçš„ç”Ÿæˆå’Œæ¶ˆè´¹æ“ä½œ
    - ç”Ÿäº§æ•°æ®ï¼š
      ```
      from components import *
      
      # 1.ç”Ÿæˆå•æ¡æ•°æ®
      KafkaManager.produce(
            "topic_name",
            {
                "id": generate_key(),
                "value": 0,
            },
        )
      
      # 2.æ‰¹é‡ç”Ÿäº§ä¹Ÿæ˜¯æ¬¢è¿çš„ï¼ŒPS:æ‰¹é‡ç”Ÿäº§ä¹Ÿä¸éœ€è¦å…³å¿ƒé˜Ÿåˆ—çš„é•¿åº¦ï¼Œä¼šè‡ªåŠ¨è¿›è¡Œåˆ†æ‰¹å‘é€ï¼Œæ‰€ä»¥æœ‰å¾ˆé•¿çš„æ•°æ®å°±ä¸€è‚¡è„‘æ‰”è¿›å»ä¹Ÿæ²¡å…³ç³»
      KafkaManager.produce(
            "topic_name",
            [{"id": generate_key()} for i in range(10000)],
        )
      ```
    - æ¶ˆè´¹æ•°æ®ï¼š`KafkaManager.consume`æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œå¯ä»¥ä¸æ–­çš„ä»kafkaä¸­æ¶ˆè´¹æ•°æ®ï¼Œé™¤éè§¦å‘äº†å¼‚å¸¸ã€‚
      ```
      from components import *
      
      # 1.æ¶ˆè´¹å•ä¸€Topicçš„æ•°æ®
      for data in KafkaManager.consume("topic_name"):
          assert isinstance(data, dict)
      
      # 2.åŒæ—¶æ¶ˆè´¹å¤šä¸ªTopicä¹Ÿæ˜¯å¯ä»¥çš„
      for data in KafkaManager.consume("topic_name1", "topic_name2"):
          assert isinstance(data, dict)
      
      # 3.æ‰¹é‡æ¶ˆè´¹æ•°æ®: é€šè¿‡limitå‚æ•°å¯ä»¥æŒ‡å®šæ¯æ¬¡æ¶ˆè´¹çš„æ•°æ®é‡ï¼Œå¦‚æœä¸æŒ‡å®šé»˜è®¤åˆ™æ˜¯ä¸Šé¢çš„å•æ¡æ¶ˆè´¹
      for data in KafkaManager.consume("topic_name", limit=1000):
          assert isinstance(data, list)
          assert len(data) == 1000
        
      # 4.æå‰åˆ›å»ºå¥½consumerï¼šconsumerå‚æ•°é»˜è®¤æ˜¯Noneï¼Œæ­¤æ—¶ä¼šæ ¹æ®topic_nameè‡ªåŠ¨åˆ›å»ºconsumerï¼Œå¦‚æœæŒ‡å®šconsumeråˆ™ä½¿ç”¨æå‰åˆ›å»ºå¥½çš„consumer
      # PSï¼šè‡ªåŠ¨åˆ›å»ºçš„consumeråœ¨å¼‚å¸¸å‘ç”Ÿæ—¶é™¤äº†ä¼šä¸­æ–­ç”Ÿæˆå™¨ä¹Ÿä¼šè‡ªåŠ¨å…³é—­å’Œå–æ¶ˆè®¢é˜…ï¼Œä½†æ˜¯å¦‚æœæ‰‹åŠ¨åˆ›å»ºäº†consumeråˆ™ä¸ä¼šè‡ªåŠ¨å…³é—­ï¼Œéœ€è¦æ‰‹åŠ¨å…³é—­
      consumer = KafkaManager.get_consumer("topic_name")
      for data in KafkaManager.consume(consumer=consumer):
          assert isinstance(data, dict)
      
      # 5.éJSONæ ¼å¼çš„æ•°æ®æ¶ˆè´¹ï¼šé»˜è®¤æ˜¯æŠŠæ•°æ®å½“ä½œJSONæ ¼å¼è¿›è¡Œæ¶ˆè´¹å¹¶è½¬æ¢æˆpythonçš„æ•°æ®ç±»å‹ï¼Œä½†æ˜¯ä¹Ÿæ”¯æŒéJSONæ ¼å¼
      for data in KafkaManager.consume("topic_name", need_load=False):
          assert isinstance(data, bytes)
      ```
  - `RedisManager`ï¼šæœ¬è´¨ä¸Šå°±æ˜¯ç”¨æ¥è·å–Redisçš„Clientï¼Œä½†æ˜¯å¯ä»¥ä¸ç”¨å…³å¿ƒå…·ä½“çš„è¿æ¥å‚æ•°æ˜¯ä»€ä¹ˆï¼ŒåŒæ—¶é’ˆå¯¹â€œå¯¹è±¡â€æ ¼å¼ç®€å•è¿›è¡Œäº†å°è£…ã€‚
    ```
    from components import *
    
    redis = RedisManager.get_client()
    redis.incrby("key", 1)
    redis.get("key")
    
    # ä¹Ÿå¯ä»¥æŒ‡å®šdb
    redis1 = RedisManager.get_client(1)
    
    # å¦‚æœéœ€è¦å­˜å–å¯¹è±¡çš„è¯å¯ä»¥ç›´æ¥ç”¨ç±»æ–¹æ³•
    RedisManager.set_object("key", {"a": 1})
    RedisManager.set_object("key1", {"a": 1}, ex=60)  # è®¾ç½®è¿‡æœŸæ—¶é—´
    RedisManager.get_object("key") == {"a": 1}
    RedisManager.get_object("unexist_key", 100) == 100  # å¯ä»¥æŒ‡å®škeyä¸å­˜åœ¨æ—¶çš„é»˜è®¤å€¼
    ```
  - `SecretManager`ï¼šåŠ å¯†è§£å¯†ç›¸å…³çš„æ“ä½œï¼Œå¯ä»¥å¯¹ä¸€äº›æ•æ„Ÿä¿¡æ¯è¿›è¡ŒåŠ å¯†ï¼Œæ¯”å¦‚å¯†ç ã€å¯†é’¥ç­‰ã€‚
    ```
    from components import *
    
    # åŠ å¯†
    secret = SecretManager.encrypt("123456")
    assert secret != "123456"  # åŠ å¯†åçš„å†…å®¹å–å†³äºå¯†é’¥æ˜¯ä»€ä¹ˆï¼Œå› æ­¤ç”Ÿäº§ç¯å¢ƒä¸èƒ½ä½¿ç”¨éšæœºå¯†é’¥
    # è§£å¯†
    assert SecretManager.decrypt(secret) == "123456"
    ```
  - å…¶ä»–è¯¸å¦‚`bytes_to_str`ï¼Œ`str_to_bytes`ç­‰ä¸å†ä¸€ä¸€è¿½æœ”ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½æœ‰å¯¹åº”çš„æ³¨é‡Šè¯´æ˜ã€‚
